<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>EDAV Project</title>
		<script src="https://d3js.org/d3.v4.min.js"></script>  <!-- link to D3 library -->
		<script src="https://unpkg.com/d3-simple-slider/build/d3-simple-slider.js"></script>
			<style type="text/css">
				.star {
					stroke: #00a1ce;
					stroke-width: 2.5px;
					fill: #fff;
					opacity: 0;
				}


				#buttons {
					margin: 0px 0px 0px 15px;
					padding: 0px;
				}

				.button {
					display: inline-block;
					margin: 0px 2px 0px 0px;
					padding: 4px 6px;
					line-height: 20px;
					background:#ff0000;
					min-width: 60px;
					border-radius: 3px;
					text-align: center;
					color: #fff;
					font-family: Arial, sans-serif;
					font-size: 12px;
					font-weight: bold;
					text-transform: uppercase;
				}

				.button:hover {
					background:#e3120b;
					color: #fff;
					cursor: pointer;
				}

				.button span {
					margin: 0px;
					padding: 0px 3px;
				}

			</style>
	</head>
	
	<body>	
    <div style="width: 600px">
	
			<h3>How much do you need to save for your retirement?</h3>
		
			<p>Assumptions</P>
			<p>retirement age: 65, Pre-retirement investment return: 6.5%, Inflation rate: 2.25%, Years in Retirement: 30</p>

			<p>
				<div class="curAge">
					<div class="col-sm-2">
						<p id="value1"></p>
					</div>
					<div class="col-sm">
						<div id="slider1"></div>
					</div>
				</div>


				<div class="hhIncome">
					<div class="col-sm-2">
						<p id="value2"></p>
					</div>
					<div class="col-sm">
						<div id="slider2"></div>
					</div>
				</div>

				<div class="annSavings">
					<div class="col-sm-2">
						<p id="value3"></p>
					</div>
					<div class="col-sm">
						<div id="slider3"></div>
					</div>
				</div>


				<div class="curSavings">
					<div class="col-sm-2">
						<p id="value4"></p>
					</div>
					<div class="col-sm">
						<div id="slider4"></div>
					</div>
				</div>

			</p>
			<p>
				<div id="buttons">
					<div class="button" id="go" value="go">Go<span class="fa fa-caret-right"></span></div>
				</div>
			</p>
		
	  </div>
	  
		  
<script>
	var slider_height = 70;

	var curAge_def = 40;
	var curAge_Msg = "Current Age: ";
	var curAge_width = 200;
	
	var hhIncome_def = 100000;
	var hhIncome_msg = "Househome Income (US$): ";
	var hhIncome_width = 500;

	var annSavings_def = 10000;
	var annSavings_msg = "Annual Savings (US$): ";
	var annSavings_width = 500;

	var curSavings_def = 50000;
	var curSavings_msg = "Current Savings (US$): ";
	var curSavings_width = 500;


	// Setting sliders
	
	// Slider #1 setting
	var slider1 = d3.sliderHorizontal()
		.min(30)
		.max(65)
		.step(1)
		.width(curAge_width*0.8)
		.displayValue(true)
		.on("onchange", val => {
			msg = curAge_Msg + val;
			d3.select("p#value1").text(msg);
			console.log(msg);
		});

	var group1 = d3.select("div#slider1").append("svg")
		.attr("width", curAge_width)
		.attr("height", slider_height)
		.append("g")
		.attr("transform", "translate(30,30)");

	group1.call(slider1);
	
	// Slider #2 setting
	var slider2 = d3.sliderHorizontal()
		.min(25000)
		.max(300000)
		.step(25000)
		.width(hhIncome_width*0.9)
		.displayValue(true)
		.on("onchange", val => {
			msg = hhIncome_msg + val;
			d3.select("p#value2").text(msg);
			console.log(msg);
		});

	var group2 = d3.select("div#slider2").append("svg")
		.attr("width", hhIncome_width)
		.attr("height", slider_height)
		.append("g")
		.attr("transform", "translate(30,30)");

	group2.call(slider2);
	

	// Slider #3 setting
	var slider3 = d3.sliderHorizontal()
		.min(0)
		.max(200000)
		.step(5000)
		.width(annSavings_width*0.9)
		.displayValue(true)
		.on("onchange", val => {
			msg = annSavings_msg + val;
			d3.select("p#value3").text(msg);
			console.log(msg);
		});

	var group3 = d3.select("div#slider3").append("svg")
		.attr("width", annSavings_width)
		.attr("height", slider_height)
		.append("g")
		.attr("transform", "translate(30,30)");

	group3.call(slider3);


	// Slider #4 setting
	var slider4 = d3.sliderHorizontal()
		.min(0)
		.max(300000)
		.step(25000)
		.width(curSavings_width*0.9)
		.displayValue(true)
		.on("onchange", val => {
			msg = curSavings_msg + val;
			d3.select("p#value4").text(msg);
			console.log(msg);
		});

	var group3 = d3.select("div#slider4").append("svg")
		.attr("width", curSavings_width)
		.attr("height", slider_height)
		.append("g")
		.attr("transform", "translate(30,30)");

	group3.call(slider4);



	// Draw sliders
	d3.select("p#value1").text(curAge_Msg+ (slider1.value()));
	d3.select("p#value2").text(hhIncome_msg + (slider2.value()));
	d3.select("p#value3").text(annSavings_msg + (slider3.value()));
	d3.select("p#value4").text(curSavings_msg + (slider4.value()));


	//Width and height of svg
	var w = 600;
	var h = 400;
	var x_padding = 70;
	var y_padding = 25;
	
	// axis min / max
	var xmin = 25;
	var xmax = 70;
	var ymin = 0;
	var ymax = 2000000;
	

	//		Scale functions
	var innerWidth = w - 2*x_padding;
	var innerHeight = h - 2*y_padding;
	
	var xScale = d3.scaleLinear()
								.domain([xmin, xmax])
								.range([0, innerWidth]);
	var yScale = d3.scaleLinear()
								.domain([ymin, ymax])
								.range([innerHeight, 0]);
	var yScale2 = d3.scaleLinear()
								.domain([ymin, ymax])
								.range([innerHeight, 0]);
	
								

	//    Define X axis and Y axis

	var xAxis = d3.axisBottom()
				.scale(xScale)
				.ticks(10);

	var yAxis = d3.axisLeft()
				.scale(yScale)
				.ticks(10);

	var yAxis2 = d3.axisRight()
				.scale(yScale2)
				.ticks(10);
				
	var cx = x_padding;
	var cy = h - y_padding;
	var rx = w - x_padding;

	//    Create SVG element		
	var svg_chart = d3.select("body")
							.append("svg")
							.attr("width", w)
							.attr("height", h)
							.attr("id", "chart");

	svg_chart.append("rect")
							.attr("x", 0)
							.attr("y", 0)
							.attr("width", w)
							.attr("height", h)
							.attr("fill", "lightgrey");

	
	//	Bind data	
	var star = svg_chart.append("g").attr("id", "star").selectAll("circle").data(star_dataset);

	
	//    Create axes
	var axes_x = svg_chart.append("g")
							.attr("id", "xAxis")
							.attr("transform", `translate (${x_padding}, ${cy})`)
							.call(xAxis);
								
	var axes_y = svg_chart.append("g")
							.attr("id", "yAxis")
							.attr("transform", `translate (${cx}, ${y_padding})`)
							.call(yAxis);

	var axes_y2 = svg_chart.append("g")
							.attr("id", "yAxis2")
							.attr("transform", `translate (${rx}, ${y_padding})`)
							.call(yAxis2);

	var map = {};
	var goal = 0;
	var n;    // the number of years until retirement
	var current_age;
	
	var req_cur_savings = 0;  // Required current savings (in $) to meet your standard of living in retirement
	var req_ann_savings = 0;  // Required annual savings in the future (in $) to meet your standard of living in retirement
	
	var inv_ret = 0.065;      // The expected return for your investment from today to retirement.
	var req_ann_savings_ratio = 0.05;  // The required percentage of your household income to save in order to meet your Goal(star).
	var retirement_age = 65;
	
	var star_key;   // "age"+"goal"    - parseInt(goal)
	var star_dataset = [];
	
	
	d3.csv("./checkpoint2.csv", function(error, data) {
	  if (error) throw error;
	  
		data.forEach(function(d) {
//			d.key = d.key;
//			d.curAge = d.curAge;
//			d.hhIncome = d.hhIncome;
//			d.value = d.value;
			map[d.key] = d.value;
		});
		
		console.log(map);

		
//		var chart_svg = d3.select("body").selectAll("input");
//		var radio_status = "add";
	
//		chart_svg.on("change", function() {
//			radio_status = this.value;
//		});
	

		d3.select("#go").on("click", function(){
			console.log("go.");
			console.log("Go button is clicked");
			console.log("Current age:", slider1.value());
			console.log("Household income:", slider2.value());
			console.log("Annual savings:", slider3.value());
			console.log("Current total savings:", slider4.value());
			
			current_age = slider1.value();
			n = retirement_age - current_age;
			var usr_hhIncome = slider2.value();
			var usr_annSavings = slider3.value();
			var key = parseInt(String(slider1.value())+String(slider2.value()));
			req_ann_savings = usr_hhIncome * req_ann_savings_ratio;
			req_cur_savings = map[key]*usr_hhIncome;
			
			goal = req_cur_savings * Math.pow( 1 + req_ann_savings_ratio, n) +
							(req_ann_savings * (1+req_ann_savings_ratio) * ((Math.pow( 1+req_ann_savings_ratio, n )-1) / req_ann_savings_ratio));
						
			console.log("Goal: " + goal);
			
			yScale.domain([ymin, goal * 1.3]);
			yScale2.domain([ymin, goal * 1.3]);

			
			svg_chart.select("#yAxis")
				.transition()
				.duration(1000)
				.call(yAxis)
				.transition()
				.duration(500)

			svg_chart.select("#yAxis2")
				.transition()
				.duration(1000)
				.call(yAxis2)
				.transition()
				.duration(500)
			
			star_dataset[0] = xScale(65);
			star_dataset[1] = yScale(goal);
			update()
			
		});


		//    Update stats function
		function update() {
				star_key = String(current_age) + String(parseInt(goal));
		
				svg_chart.select("#star").data(star_dataset)
						.append("circle")
						.attr("id", star_key)
						.attr("cx", xScale(65))
						.attr("cy", yScale(goal))
						.attr("r", 1)
						.transition()
						.duration(1000)
						.attr("r", 10)
						.attr("fill", "red")
		
		}
	
		//    Click behavior			
		svg_chart.select("rect").on("click", function(d, i) {
			console.log("mouse clicked");

		});	
		
	});



	

</script>
		
	</body>
	
</html>
	
